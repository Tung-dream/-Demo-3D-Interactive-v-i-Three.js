<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Demo cube xoay perfect - Three.js</title>
  <style>
    body { margin: 0; overflow: hidden; background-color: #000; }
    h1 {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      z-index: 1;
      font-family: Arial, sans-serif;
    }
    #modelSelect {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1;
      padding: 5px;
      font-family: Arial, sans-serif;
    }
    #loading {
      position: absolute;
      top: 80px;
      left: 10px;
      color: white;
      z-index: 1;
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <h1>Demo cube xoay với Duck 🦆</h1>
  <div id="loading">Loading Duck model...</div>
  
  <!-- Model Selector -->
  <select id="modelSelect">
    <option value="duck">Duck 🦆</option>
    <option value="robot">Robot 🤖</option>
    <option value="car">Car 🚗</option>
    <option value="tree">Cái cây 🌳</option>
  </select>
  
  <!-- Load libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  
  <script>
    // Model configurations
    const models = {
      duck: {
        name: 'Duck 🦆',
        url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb',
        scale: 15
      },
      robot: {
        name: 'Robot 🤖',
        url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/RobotExpressive/glTF-Binary/RobotExpressive.glb',
        scale: 18
      },
      car: {
        name: 'Car 🚗',
        url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/ToyCar/glTF-Binary/ToyCar.glb',
        scale: 12
      },
      tree: {
        name: 'Cái cây 🌳',
        url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/BoomBox/glTF-Binary/BoomBox.glb',
        scale: 20
      }
    };

    // Tạo scene
    const scene = new THREE.Scene();
    
    // Tạo camera
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 150);
    camera.lookAt(0, 0, 0);
    
    // Tạo renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setClearColor(0x111111);
    renderer.shadowMap.enabled = true; // Enable shadows
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);

    // OrbitControls
    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.enableZoom = true;
    controls.target.set(0, 0, 0);
    controls.update();

    // Ánh sáng cải thiện
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    const pointLight = new THREE.PointLight(0xffffff, 1.5);
    pointLight.position.set(50, 50, 50);
    pointLight.castShadow = true; // Enable shadows
    scene.add(ambientLight, pointLight);

    // ánh sáng mặt trời
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5, 10, 7.5);
    scene.add(dirLight);

    // ánh đèn sân khấu
    const spotLight = new THREE.SpotLight(0xffffff);
    spotLight.position.set(10, 20, 10);
    spotLight.castShadow = true;
    scene.add(spotLight);

    // Tạo cube
    const geometry = new THREE.BoxGeometry(35, 35, 35);
    const material = new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.5, roughness: 0.5 });
    const cube = new THREE.Mesh(geometry, material);
    cube.castShadow = true;
    cube.receiveShadow = true;
    scene.add(cube);

    // Tạo sphere
    const sphereGeometry = new THREE.SphereGeometry(25, 32, 32);
    const sphereMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff, metalness: 0.5, roughness: 0.5 });
    const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
    sphere.position.set(0, -20, 0);
    sphere.castShadow = true;
    sphere.receiveShadow = true;
    scene.add(sphere);

    // Tạo cone
    const coneGeometry = new THREE.ConeGeometry(25, 50, 32);
    const coneMaterial = new THREE.MeshStandardMaterial({ color: 0xffff00, metalness: 0.5, roughness: 0.5 });
    const cone = new THREE.Mesh(coneGeometry, coneMaterial);
    cone.position.set(20, 0, 0);
    cone.castShadow = true;
    cone.receiveShadow = true;
    scene.add(cone);

    // Biến để lưu current model
    let currentModel = null;
    let currentModelKey = 'duck';
    let interactiveObjects = [cube, sphere, cone]; // Array để lưu objects có thể click

    // Load model function
    const loader = new THREE.GLTFLoader();
    const loadingDiv = document.getElementById('loading');
    const h1 = document.querySelector('h1');

    function loadModel(modelKey) {
      const modelConfig = models[modelKey];
      if (!modelConfig) return;

      // Update UI
      loadingDiv.style.display = 'block';
      loadingDiv.innerHTML = `Loading ${modelConfig.name} model...`;
      h1.innerHTML = `Demo cube xoay với ${modelConfig.name}`;

      // Remove current model
      if (currentModel) {
        scene.remove(currentModel);
        // Reset interactive objects to basic shapes only
        interactiveObjects = [cube, sphere, cone];
      }

      // Load new model
      loader.load(
        modelConfig.url,
        function (gltf) {
          currentModel = gltf.scene;
          currentModel.scale.set(modelConfig.scale, modelConfig.scale, modelConfig.scale);
          currentModel.position.set(-60, -30, 0);
          
          // Enable shadows
          currentModel.traverse(function (child) {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              // Thêm vào danh sách objects có thể click
              interactiveObjects.push(child);
            }
          });
          
          scene.add(currentModel);
          loadingDiv.style.display = 'none';
          currentModelKey = modelKey;
          console.log(`${modelConfig.name} loaded successfully!`);
        },
        function (progress) {
          if (progress.total > 0) {
            const percent = Math.round((progress.loaded / progress.total) * 100);
            loadingDiv.innerHTML = `Loading ${modelConfig.name}... ${percent}%`;
          }
        },
        function (error) {
          console.error(`Lỗi tải mô hình ${modelConfig.name}:`, error);
          loadingDiv.innerHTML = `Failed to load ${modelConfig.name} model 😢`;
        }
      );
    }

    // Model selector event listener
    const modelSelect = document.getElementById('modelSelect');
    modelSelect.addEventListener('change', function() {
      loadModel(this.value);
    });

    // Load default model (Duck)
    loadModel('duck');

    // Tốc độ xoay
    let rotationSpeed = 0.01;

    // Bắt sự kiện phím (thêm điều khiển cho model)
    window.addEventListener('keydown', (event) => {
      switch (event.key) {
        case 'ArrowUp':
          rotationSpeed += 0.01;
          break;
        case 'ArrowDown':
          rotationSpeed = Math.max(0, rotationSpeed - 0.01);
          break;
        case 'r':
          cube.material.color.set(0xffffff);
          sphere.material.color.set(0x00ff00);
          cone.material.color.set(0xffff00);
          break;
        case 'g':
          cube.material.color.set(0xff69b4); 
          sphere.material.color.set(0xffa500);
          cone.material.color.set(0xffffff);
          break;
        case 'b':
          cube.material.color.set(0xff0000); 
          sphere.material.color.set(0x808080);
          cone.material.color.set(0xFFD700);
          break;
        case 'y':
          cube.material.color.set(0x8B4513);
          sphere.material.color.set(0x00ff00);
          cone.material.color.set(0xff69b4);
          break;
        case 'd': // Phím D để làm model nhảy
          if (currentModel) {
            currentModel.position.y += 20;
            setTimeout(() => {
              if (currentModel) currentModel.position.y -= 20;
            }, 500);
          }
          break;
      }
    });

    // Xử lý resize
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Chuyển động vật thể tự động
    let direction = 1;

    // Thay đổi màu vật thể khi nhấn chuột (cải thiện để work với model)
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    window.addEventListener('click', (event) => {
      // Skip if clicking on UI elements
      if (event.target.closest('#modelSelect')) {
        return;
      }

      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(interactiveObjects, true); // recursive = true

      if (intersects.length > 0) {
        const clickedObject = intersects[0].object;
        if (clickedObject.material && clickedObject.material.color) {
          const randomColor = Math.random() * 0xffffff;
          clickedObject.material.color.set(randomColor);
          console.log('Clicked object color changed! 🎨');
        }
      }
    });

    // Giao diện đổi màu với dat.GUI
    const gui = new dat.GUI();
    const colors = {
      cubeColor: '#ff0000',
      sphereColor: '#0000ff',
      coneColor: '#ffff00'
    };

    const controls_gui = {
      rotationSpeed: rotationSpeed,
      modelJump: function() {
        if (currentModel) {
          currentModel.position.y += 20;
          setTimeout(() => {
            if (currentModel) currentModel.position.y -= 20;
          }, 500);
        }
      }
    };

    gui.addColor(colors, 'cubeColor').name('Cube Color').onChange((value) => {
      cube.material.color.set(value);
    });

    gui.addColor(colors, 'sphereColor').name('Sphere Color').onChange((value) => {
      sphere.material.color.set(value);
    });

    gui.addColor(colors, 'coneColor').name('Cone Color').onChange((value) => {
      cone.material.color.set(value);
    });

    gui.add(controls_gui, 'rotationSpeed', 0, 0.1).onChange((value) => {
      rotationSpeed = value;
    });

    gui.add(controls_gui, 'modelJump').name('Model Jump! 🚀');

    // Vòng lặp animate
    function animate() {
      requestAnimationFrame(animate);

      // Xoay cube
      cube.rotation.x += rotationSpeed;
      cube.rotation.y += rotationSpeed;

      // Xoay sphere
      sphere.rotation.x += rotationSpeed;
      sphere.rotation.y += rotationSpeed;

      // Xoay cone
      cone.rotation.x += rotationSpeed;
      cone.rotation.y += rotationSpeed;

      // Xoay current model nếu đã load
      if (currentModel) {
        currentModel.rotation.y += rotationSpeed * 0.5; // Model xoay chậm hơn
      }

      // Di chuyển tự động
      cube.position.x += 0.5 * direction;
      if (cube.position.x > 100 || cube.position.x < -100)
        direction *= -1;

      sphere.position.y += 0.5 * direction;
      if (sphere.position.y > 100 || sphere.position.y < -100)
        direction *= -1;

      sphere.position.x -= 0.1 * direction;

      // Tạo hiệu ứng lắc lư
      cube.position.y = Math.sin(Date.now() * 0.001) * 50;
      sphere.position.x = Math.cos(Date.now() * 0.001) * 50;
      cone.position.y = Math.sin(Date.now() * 0.001) * 50;

      // Model floating effect
      if (currentModel) {
        currentModel.position.x = Math.sin(Date.now() * 0.0008) * 30 - 60;
      }

      // IMPORTANT: Update controls
      controls.update();
      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
